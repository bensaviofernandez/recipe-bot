<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quick Recipe Recommender UI</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 2rem auto;
      line-height: 1.5;
    }
    h1 {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    section {
      margin-bottom: 2rem;
      border: 1px solid #ddd;
      padding: 1rem;
      border-radius: 6px;
    }
    section h2 {
      margin-top: 0;
    }
    input {
      width: 70%;
      padding: 0.5rem;
      margin-right: 0.5rem;
    }
    button {
      padding: 0.5rem 1rem;
    }
    .results {
      margin-top: 1rem;
    }
    .ingredients {
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    .recipe {
      margin-bottom: 1rem;
    }
    .recipe h3 {
      margin: 0.5rem 0 0.25rem;
    }
    .error {
      color: #a00;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Quick Recipe Recommender</h1>

  <section id="image-section">
    <h2>Image-based Recommendation</h2>
    <input type="text" id="imageUrl" placeholder="Enter image URL" />
    <button id="imageSubmit">Get Recipes</button>
    <div id="imageResult" class="results"></div>
  </section>

  <section id="text-section">
    <h2>Text-based Recommendation</h2>
    <input type="text" id="ingredients" placeholder="Enter comma-separated ingredients" />
    <button id="textSubmit">Get Recipes</button>
    <div id="textResult" class="results"></div>
  </section>

  <script>
    function normalizeGitHubUrl(u) {
      const m = u.match(
        /^https:\/\/github\.com\/([^\/]+)\/([^\/]+)\/blob\/([^\/]+)\/(.+)$/
      );
      if (m) {
        const [, user, repo, branch, path] = m;
        return `https://raw.githubusercontent.com/${user}/${repo}/${branch}/${path}`;
      }
      return u;
    }

    async function postJson(path, body) {
      const res = await fetch(path, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      return res.json();
    }

    function renderResult(container, data, [key0, key1, key2]) {
        container.innerHTML = '';
        if (data.error) {
        container.innerHTML = `<div class="error">${data.error}</div>`;
        return;
        }

        // 1) Detected ingredients
        const ing = Array.isArray(data[key0]) ? data[key0].join(', ') : '';
        container.innerHTML = `<div class="ingredients">Detected: ${ing}</div>`;

        const recipes  = data[key1] || [];
        const textBlock = (data[key2] || '').trim();

        // 2) Try splitting into one entry per recipe
        let lines = textBlock.split(/\r?\n/).map(l => l.trim()).filter(l => l);

        // If LLM gave it all on one line, split on numbering: “1.” “2.” …
        if (lines.length === 1 && recipes.length > 1) {
        lines = textBlock.split(/\d+\.\s*/).map(l => l.trim()).filter(l => l);
        }

        // If still one chunk, split on sentences
        if (lines.length === 1 && recipes.length > 1) {
        lines = textBlock.split(/(?<=\.)\s+/).map(l => l.trim()).filter(l => l);
        }

        // 3) Render each recipe
        recipes.forEach((r, idx) => {
        const div = document.createElement('div');
        div.className = 'recipe';

        const h3 = document.createElement('h3');
        h3.textContent = `${idx+1}. ${r.name} (${r.cook_time} min)`;

        const p = document.createElement('p');
        // pick the matching line, or fallback to the entire block
        const raw = lines[idx] || textBlock;
        // strip any leading bullets/numbers
        p.textContent = raw.replace(/^[-\d\.\s]*/, '');

        div.appendChild(h3);
        div.appendChild(p);
        container.appendChild(div);
        });

        // 4) If no recipes at all, just show the raw text
        if (!recipes.length) {
        const p = document.createElement('p');
        p.textContent = textBlock;
        container.appendChild(p);
        }
    }

    document.getElementById('imageSubmit').onclick = async () => {
      const out = document.getElementById('imageResult');
      out.textContent = 'Loading…';
      let url = document.getElementById('imageUrl').value.trim();
      url = normalizeGitHubUrl(url);
      if (!/\.(jpe?g|png|gif)$/i.test(url)) {
        out.innerHTML = '<div class="error">Please enter a direct image URL (.jpg/.png/.gif).</div>';
        return;
      }
      const data = await postJson('/recommend', { imageUrl: url });
      renderResult(out, data, ['detected', 'suggestions', 'recommendation']);
    };

    document.getElementById('textSubmit').onclick = async () => {
      const out = document.getElementById('textResult');
      out.textContent = 'Loading…';
      const raw = document.getElementById('ingredients').value;
      const ingredients = raw.split(',').map(i => i.trim()).filter(Boolean);
      if (!ingredients.length) {
        out.innerHTML = '<div class="error">Please enter at least one ingredient.</div>';
        return;
      }
      const data = await postJson('/recommend-text', { ingredients });
      renderResult(out, data, ['ingredients', 'suggestions', 'recommendation']);
    };
  </script>
</body>
</html>
